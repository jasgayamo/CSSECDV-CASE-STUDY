<%- include('header') %>
<h2>Available Products</h2>

<% if (error) { %>
  <div style="color: red; margin-bottom: 10px;"><%= error %></div>
<% } %>

<% if (message) { %>
  <div id="successModal" class="modal" style="display: block;">
    <div class="modal-content">
      <h4>Success</h4>
      <p><%= message %></p>
      <button onclick="closeSuccessModal()">OK</button>
    </div>
  </div>
<% } %>


<ul>
    <% products.forEach(p => { %>
        <li>
          <strong><%= p.name %></strong>
          <% if (p.createdBy) { %>
            by <%= p.createdBy.username %>
          <% } else { %>
            by Unknown
          <% } %>
          <br>
          <%= p.description %> - â‚±<%= p.price %>
          <!-- Button to open the modal for username and password confirmation -->
          <button type="button" onclick="openPasswordModal('/customer/order/<%= p._id %>')">Order</button>
        </li>
    <% }) %>
</ul>

<!-- Modal for Username and Password Confirmation -->
<div id="passwordModal" class="modal">
  <div class="modal-content">
    <h4>Confirm Your Order</h4>
    <form id="passwordForm" method="POST">
      <label for="usernameInput">Username:</label>
      <input type="text" id="usernameInput" name="username" placeholder="Enter your username" required />

      <label for="passwordInput">Password:</label>
      <input type="password" id="passwordInput" name="password" placeholder="Enter your password" required />
      
      <button type="submit">Submit</button>
      <button type="button" onclick="closeModal()">Cancel</button>
    </form>
  </div>
</div>

<!-- Add a button to redirect to the user's dashboard -->
<a href="/dashboard"><button type="button">Go to Dashboard</button></a>

<%- include('footer') %>

<!-- Modal Styles (CSS) -->
<style>
  .modal {
    display: none; /* Hidden by default */
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgb(0,0,0);
    background-color: rgba(0,0,0,0.4);
    padding-top: 60px;
  }

  .modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
  }

  .modal button {
    margin-top: 10px;
  }
</style>

<!-- Modal Script -->
<script>
  function openPasswordModal(actionUrl) {
    // Set the action URL for the form dynamically
    document.getElementById('passwordForm').action = actionUrl;

    // Display the modal
    document.getElementById('passwordModal').style.display = "block";
  }

  function closeModal() {
    // Close the modal
    document.getElementById('passwordModal').style.display = "none";
  }

  // Close the modal if clicked outside of the modal content
  window.onclick = function(event) {
    if (event.target == document.getElementById('passwordModal')) {
      closeModal();
    }
  }

  function closeSuccessModal() {
    document.getElementById('successModal').style.display = "none";
    // Remove the message parameter from URL without reloading
    const url = new URL(window.location.href);
    url.searchParams.delete('message');
    window.history.replaceState({}, document.title, url.toString());
  }

  window.onload = function() {
    setTimeout(function() {
      // Clear error and message from URL
      window.history.replaceState({}, document.title, window.location.pathname);
    }, 3000);  // Optional: Wait for 3 seconds before clearing
  };

</script>
